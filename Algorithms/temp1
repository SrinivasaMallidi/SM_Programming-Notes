from django.shortcuts import render, redirect, get_object_or_404
import pandas as pd
from django.http import JsonResponse
from .models import Vulnerability, Proof
from datetime import datetime
from collections import defaultdict

# Create your views here.

def home(request):  
    vulnerabilities = Vulnerability.objects.all().order_by('VITNUMBER')
   

    # Dictionary to store summary data for each vulnerability
    vulnerability_summary = defaultdict(lambda: {'count': 0, 'months': set(), 'states': set()})
    for vulnerability in vulnerabilities:
        vitnumber = vulnerability.VITNUMBER
        # Increment the record count
        vulnerability_summary[vitnumber]['count'] += 1
        # Add the month to the set of months
        vulnerability_summary[vitnumber]['months'].add(vulnerability.MONTH)
        # Add the state to the set of states
        vulnerability_summary[vitnumber]['states'].add(vulnerability.STATE)
    
    sri_vulnerability_summary = []
    # Convert sets to lists for easier rendering in the template
    for vitnumber, summary_data in vulnerability_summary.items():
        print(vitnumber,summary_data)
        # Convert dates to strings and join them
        #summary_data['months'] = ', '.join(sorted(date.strftime('%b %Y') for date in summary_data['months']))
        monthlist = []
        for date in summary_data['months']:
            monthlist.append(date.strftime('%b %Y'))
        summary_data['states'] = 'OPEN' if 'OPEN' in summary_data['states'] else 'CLOSED'
        sri_vulnerability_summary.append([vitnumber, summary_data['count'] ,monthlist, summary_data['states'] ])
        print(sri_vulnerability_summary)

    context = {
        'vulnerability_summary': sri_vulnerability_summary
    }

    return render(request, 'vulnerability/home.html',context)


def get_proofs(request):
    print("inside get_proofs")
    if request.method == 'GET' and 'vitnumber' in request.GET:
        vitnumber = request.GET.get('vitnumber')
        print("inside get_proofs VIT"+str(vitnumber))
        proofs = Proof.objects.filter(vulnerability__VITNUMBER=vitnumber)
        proofs_data = [{'proof': proof.PROOF} for proof in proofs]  # Adjust 'proof_field' as per your Proof model
        print("inside get_proofs proofs_data"+str(proofs_data))
        return JsonResponse(proofs_data, safe=False)
    else:
        return JsonResponse({'error': 'Invalid request'}, status=400)

def upload_excelbkp(request):
    if request.method == 'POST':
        excel_file = request.FILES.get('excel_file')
        if excel_file:
            # Read Excel file using pandas
            excel_data = pd.read_excel(excel_file)
            print(excel_data)
            # Pass the data to the template
            return render(request, 'vulnerability/home.html', {'excel_data': excel_data})

    # If no Excel file is uploaded or if request method is not POST,
    # render the template without any data
    return render(request, 'vulnerability/home.html')


def upload_excel(request):
    if request.method == 'POST':
        excel_file = request.FILES.get('excel_file')
        if excel_file:
            # Read Excel file using pandas
            excel_data = pd.read_excel(excel_file)

            for index, row in excel_data.iterrows():
                vitnumber = row['VITNUMBER']
                config_item = row['CONFIGURATION ITEM']
                summary = row['SUMMARY']
                solution = row['SOLUTION']
                severity = row['SEVERITY']
                month_timestamp = row['MONTH']
                state = row['STATE']

                # Convert the timestamp to string format
                month_str = month_timestamp.strftime('%d-%b-%Y')

                try:
                    # Parse the month string into a datetime object
                    month = datetime.strptime(month_str, '%d-%b-%Y').date()
                except ValueError:
                    print(f"Error parsing date string: {month_str}")
                    # Handle the error here (e.g., set default date or skip this row)

                # Check if Vulnerability entry exists
                vulnerability, created = Vulnerability.objects.get_or_create(
                    VITNUMBER=vitnumber,
                    CONFIGURATION_ITEM=config_item,
                    SUMMARY=summary,
                    SOLUTION=solution,
                    SEVERITY=severity,
                    MONTH=month,
                    STATE=state
                )

                # If Proof is provided in the Excel data, create a new Proof entry
                if 'PROOF' in row and not pd.isna(row['PROOF']):
                    proof_text = row['PROOF']
                    proof, _ = Proof.objects.get_or_create(vulnerability=vulnerability, PROOF=proof_text)

            # Pass the data to the template
            #return render(request, 'vulnerability/home.html', {'excel_data': excel_data})            
            return redirect('vulnerability-home')

    # If no Excel file is uploaded or if request method is not POST,
    # render the template without any data
    return redirect('vulnerability-home')


def vulnerability_details(request, vitnumber):
    # Retrieve all vulnerability objects with the given VITNUMBER
    vulnerabilities = Vulnerability.objects.filter(VITNUMBER=vitnumber)
    return render(request, 'vulnerability/vulnerability_details.html', {'vulnerabilities': vulnerabilities})
